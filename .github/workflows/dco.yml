name: DCO Check

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read

jobs:
  dco:
    name: Verify commit sign-offs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate DCO sign-off on all PR commits
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          set -euo pipefail

          echo "Checking commits in range ${BASE_SHA}..${HEAD_SHA}"

          missing=0
          while IFS= read -r commit; do
            if [[ -z "$commit" ]]; then
              continue
            fi

            if ! git log -1 --pretty=%B "$commit" | grep -Eiq '^Signed-off-by:[[:space:]]+.+<.+>$'; then
              echo "::error::Commit ${commit} is missing a valid Signed-off-by line"
              missing=1
            fi
          done < <(git rev-list "${BASE_SHA}..${HEAD_SHA}")

          if [[ "$missing" -ne 0 ]]; then
            echo "One or more commits are missing DCO sign-off. Use: git commit --amend -s (or git rebase --signoff)."
            exit 1
          fi

          echo "All commits include DCO sign-off."
